  code-{{USERNAME}}:
    build:
      context: ./containers_build/code-space
      args:
        APT_PROXY: ${APT_PROXY}
    image: codespace-techfusion:1.0.0
    container_name: code-{{USERNAME}}
    environment:
      - TZ=UTC
      - PUID=1000
      - PGID=1000
      # PASSWORD no longer needed - auth handled by OAuth2 Proxy
      - HTTP_PROXY=${HTTP_PROXY}
      - HTTPS_PROXY=${HTTPS_PROXY}
      - DEFAULT_WORKSPACE=/config/workspace
      - BASE_HREF=/code/{{USERNAME}}/proxy/4200/
      - EXTENSIONS_GALLERY={"serviceUrl":"https://marketplace.visualstudio.com/_apis/public/gallery","itemUrl":"https://marketplace.visualstudio.com/items"}
    networks:
      - code-space
    links:
      - code-db-app:code-db
      - code-cache:code-cache
    volumes:
      - ./mounts/config/{{USERNAME}}:/config
      - ./mounts/shared:/shared
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -o /dev/null http://localhost:8443 || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.code-{{USERNAME}}.tls=true"
      - "traefik.http.routers.code-{{USERNAME}}.entrypoints=websecure"
      - "traefik.http.routers.code-{{USERNAME}}.tls.certresolver=myresolver"
      # Middleware chain: auth -> trailing slash redirect -> strip prefix
      - "traefik.http.routers.code-{{USERNAME}}.middlewares=authz@docker,code-{{USERNAME}}-slash,code-{{USERNAME}}-strip"
      - "traefik.http.routers.code-{{USERNAME}}.rule=Host(`${HOSTNAME}.${DOMAIN}`) && PathPrefix(`/code/{{USERNAME}}`)"
      - "traefik.http.middlewares.code-{{USERNAME}}-slash.redirectregex.regex=^(https?://[^/]+/code/{{USERNAME}})$$"
      - "traefik.http.middlewares.code-{{USERNAME}}-slash.redirectregex.replacement=$${1}/"
      - "traefik.http.middlewares.code-{{USERNAME}}-slash.redirectregex.permanent=true"
      - "traefik.http.middlewares.code-{{USERNAME}}-strip.stripprefix.prefixes=/code/{{USERNAME}}"
      - "traefik.http.services.code-{{USERNAME}}.loadbalancer.server.port=8443"
    dns: ${DNS_HOST}
    restart: always
    depends_on:
      - authz-service

