volumes:
  local:

networks:
  tracker:
  code-space:

services:

  # This is the reverse proxy, the one that will route all the ingress traffic
  code-proxy:
    container_name: ${TRAEFIK_CONTAINER_NAME}
    image: ${TRAEFIK_IMAGE}
    restart: always
    command:
      - "--accesslog=true"
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.dnschallenge=true"
      - "--certificatesresolvers.myresolver.acme.dnschallenge.provider=${TRAEFIK_DNS_PROVIDER}"
      - "--certificatesresolvers.myresolver.acme.storage=${TRAEFIK_ACME_STORAGE}"
      - "--certificatesresolvers.myresolver.acme.email=${TRAEFIK_ACME_EMAIL}"
    environment:
      - HETZNER_API_KEY=${TRAEFIK_HETZNER_API_KEY}
    networks:
      - tracker
      - code-space
    ports:
      - "${TRAEFIK_HTTP_PORT}:80"
      - "${TRAEFIK_HTTPS_PORT}:443"
      - "${TRAEFIK_API_PORT}:8080"
    volumes:
      - ${TRAEFIK_CONF_VOLUME}/conf.d:/conf.d
      - ${TRAEFIK_ACME_VOLUME}:${TRAEFIK_ACME_STORAGE}
      - /var/run/docker.sock:/var/run/docker.sock

  # OAuth2 Proxy - handles GitHub OAuth authentication
  oauth2-proxy:
    container_name: oauth2-proxy
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    restart: always
    networks:
      - code-space
    environment:
      # GitHub OAuth provider
      - OAUTH2_PROXY_PROVIDER=github
      - OAUTH2_PROXY_CLIENT_ID=${GITHUB_CLIENT_ID}
      - OAUTH2_PROXY_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      # Cookie settings (generate with: openssl rand -hex 16)
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_COOKIE_SECRET}
      - OAUTH2_PROXY_COOKIE_SECURE=true
      - OAUTH2_PROXY_COOKIE_DOMAINS=.${DOMAIN}
      - OAUTH2_PROXY_COOKIE_SAMESITE=lax
      # Allow all emails (authorization handled by authz-service)
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      # Server settings
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_REVERSE_PROXY=true
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      - OAUTH2_PROXY_PASS_ACCESS_TOKEN=true
      # Redirect URL after OAuth
      - OAUTH2_PROXY_REDIRECT_URL=https://${HOSTNAME}.${DOMAIN}/oauth2/callback
      # Whitelist domains for redirect (required for rd parameter to work)
      - OAUTH2_PROXY_WHITELIST_DOMAINS=.${DOMAIN}
      # Upstream for auth responses (not used, authz-service handles routing)
      - OAUTH2_PROXY_UPSTREAMS=static://200
      # Session settings
      - OAUTH2_PROXY_SESSION_STORE_TYPE=cookie
      # Skip auth for the userinfo endpoint (used by authz-service)
      - OAUTH2_PROXY_SKIP_AUTH_ROUTES=^/oauth2/userinfo$$
      # Sign out configuration
      - OAUTH2_PROXY_COOKIE_EXPIRE=168h
    labels:
      - "traefik.enable=true"
      # OAuth2 proxy routes (no auth middleware - this IS the auth)
      - "traefik.http.routers.oauth2-proxy.tls=true"
      - "traefik.http.routers.oauth2-proxy.entrypoints=websecure"
      - "traefik.http.routers.oauth2-proxy.tls.certresolver=myresolver"
      - "traefik.http.routers.oauth2-proxy.rule=Host(`${HOSTNAME}.${DOMAIN}`) && PathPrefix(`/oauth2`)"
      - "traefik.http.services.oauth2-proxy.loadbalancer.server.port=4180"

  # Authorization Service - checks user permissions against YAML config
  authz-service:
    build:
      context: ./containers_build/authz-service
    container_name: authz-service
    restart: always
    networks:
      - code-space
    environment:
      - AUTHZ_CONFIG_PATH=/config/authz.yaml
      - OAUTH2_PROXY_URL=http://oauth2-proxy:4180
    volumes:
      - ./config/authz:/config:ro
    labels:
      - "traefik.enable=true"
      # Internal route for health checks (optional, for debugging)
      - "traefik.http.routers.authz-service.tls=true"
      - "traefik.http.routers.authz-service.entrypoints=websecure"
      - "traefik.http.routers.authz-service.tls.certresolver=myresolver"
      - "traefik.http.routers.authz-service.rule=Host(`${HOSTNAME}.${DOMAIN}`) && PathPrefix(`/authz`)"
      - "traefik.http.services.authz-service.loadbalancer.server.port=3000"
      # ForwardAuth middleware definition (used by protected services)
      - "traefik.http.middlewares.authz.forwardauth.address=http://authz-service:3000/auth"
      - "traefik.http.middlewares.authz.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authz.forwardauth.authResponseHeaders=X-Auth-User,X-Auth-Email"
    depends_on:
      - oauth2-proxy

  # Portal - Landing page and user dashboard
  portal:
    build:
      context: ./containers_build/portal
    container_name: portal
    restart: always
    networks:
      - code-space
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portal.tls=true"
      - "traefik.http.routers.portal.entrypoints=websecure"
      - "traefik.http.routers.portal.tls.certresolver=myresolver"
      # Lowest priority - catch-all for root path
      - "traefik.http.routers.portal.priority=1"
      - "traefik.http.routers.portal.rule=Host(`${HOSTNAME}.${DOMAIN}`)"
      - "traefik.http.services.portal.loadbalancer.server.port=3000"
    depends_on:
      - oauth2-proxy

  # This is an end user reserved database
  code-db-app:
    container_name: ${DB_APP_CONTAINER_NAME}
    image: ${DB_APP_IMAGE}
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASS}
    networks:
      code-space:
        aliases:
          - db
    volumes:
      - ${DB_APP_VOLUME}:/var/lib/mysql

  # This is an end user reserved redis service
  code-cache:
    container_name: ${CACHE_CONTAINER_NAME}
    image: ${CACHE_IMAGE}
    command: redis-server --save 20 1 --loglevel warning --requirepass ${CACHE_PASS}
    restart: always
    networks:
      code-space:
        aliases:
          - cache
    volumes:
      - ${CACHE_VOLUME}:/data

  # This container is meant to restart all unhealthy containers
  autoheal:
    container_name: code-autoheal
    image: willfarrell/autoheal:latest
    tty: true
    restart: always
    environment:
      - AUTOHEAL_INTERVAL=60
      - AUTOHEAL_START_PERIOD=300
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

