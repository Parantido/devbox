#!/bin/bash

USERNAMES_FILE=".users.db"
AUTHZ_CONFIG="./config/authz/authz.yaml"
PORTAL_PAGE="./containers_build/portal/app/page.tsx"
COMPOSE_OUT_PATH="./composers.d"
DC_HEAD_TEMPLATE="./templates/docker-compose_head-template.yml"
DC_DELTA_TEMPLATE="./templates/docker-compose_delta-template.yml"

# Retrieve OS commands abs path
CP=`which cp`               ; [[ ! -x "$CP" ]]      && (echo "Copy command not found!" ; exit 1)
RM=`which rm`               ; [[ ! -x "$RM" ]]      && (echo "Remove command not found!" ; exit 1)
TR=`which tr`               ; [[ ! -x "$TR" ]]      && (echo "Translate command not found!" ; exit 1)
WC=`which wc`               ; [[ ! -x "$WC" ]]      && (echo "Wordcount command not found!" ; exit 1)
CAT=`which cat`             ; [[ ! -x "$CAT" ]]     && (echo "Concatenate command not found!" ; exit 1)
CUT=`which cut`             ; [[ ! -x "$CUT" ]]     && (echo "Cut command not found!" ; exit 1)
SED=`which sed`             ; [[ ! -x "$SED" ]]     && (echo "Stream editor command not found!" ; exit 1)
AWK=`which awk`             ; [[ ! -x "$AWK" ]]     && (echo "Awk command not found!" ; exit 1)
ECHO=`which echo`           ; [[ ! -x "$ECHO" ]]    && (echo "Echo command not found!" ; exit 1)
FOLD=`which fold`           ; [[ ! -x "$FOLD" ]]    && (echo "Fold command not found!" ; exit 1)
GREP=`which grep`           ; [[ ! -x "$GREP" ]]    && (echo "Grep command not found!" ; exit 1)
HEAD=`which head`           ; [[ ! -x "$HEAD" ]]    && (echo "Head command not found!" ; exit 1)
TOUCH=`which touch`         ; [[ ! -x "$TOUCH" ]]   && (echo "Touch command not found!" ; exit 1)
MKDIR=`which mkdir`         ; [[ ! -x "$MKDIR" ]]   && (echo "Mkdir command not found!" ; exit 1)

# Try docker compose (v2) first, fall back to docker-compose (v1)
DC=`which docker`
if [[ -x "$DC" ]] && $DC compose version > /dev/null 2>&1; then
	DC="$DC compose"
else
	DC=`which docker-compose`
	[[ ! -x "$DC" ]] && (echo "Docker Compose command not found!" ; exit 1)
fi

# Check if the users file exists, create it if not
if [ ! -r "$USERNAMES_FILE" ]; then
	$TOUCH "$USERNAMES_FILE"
fi

# Check if the authz config directory exists
if [ ! -d "./config/authz" ]; then
	$MKDIR -p "./config/authz"
fi

# Create default authz.yaml if it doesn't exist
if [ ! -r "$AUTHZ_CONFIG" ]; then
	$CAT > "$AUTHZ_CONFIG" << 'AUTHZEOF'
# Authorization Configuration
# This file is auto-generated by devbox-setup.sh
# Manual edits to the resources section will be overwritten

default_policy: deny

groups:
  admins: []
  developers: []

resources: {}
AUTHZEOF
fi

# This function will check if the workspace name is valid
is_valid_workspace() {
	# Check if the string matches a valid workspace pattern (alphanumeric, lowercase)
	[[ "$1" =~ ^[a-z0-9]+$ ]]
}

# This function will check if the GitHub username is valid
is_valid_github_user() {
	# GitHub usernames: alphanumeric and hyphens, 1-39 chars, no consecutive hyphens
	[[ "$1" =~ ^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?$ ]] && [[ ${#1} -le 39 ]]
}

# This function will check if the workspace already exists
workspace_exists() {
	$GREP -q "^$1|" $USERNAMES_FILE
}

# This function will check if the GitHub user is already assigned
github_user_exists() {
	$GREP -q "|$1$" $USERNAMES_FILE
}

isdev_empty() {
	num=$(${WC} -l < ${USERNAMES_FILE} 2>/dev/null || echo "0")
	if [ "$num" -gt "0" ]; then
		# 1 = false (not empty)
		return 1
	fi
	# 0 = true (empty)
	return 0
}

# Update the authz.yaml file with current users
update_authz_config() {
	# Create a new authz.yaml with all users
	$CAT > "$AUTHZ_CONFIG" << 'AUTHZEOF'
# Authorization Configuration
# This file is auto-generated by devbox-setup.sh
# Manual edits to the resources section will be overwritten when using the setup script

default_policy: deny

groups:
  admins: []
  developers:
AUTHZEOF

	# Add all GitHub users to the developers group
	while IFS= read -r line; do
		[[ -z "$line" ]] && continue
		line_arr=(${line//|/ })
		[[ "${#line_arr[@]}" -lt 2 ]] && continue
		$ECHO "    - ${line_arr[1]}" >> "$AUTHZ_CONFIG"
	done < "$USERNAMES_FILE"

	$CAT >> "$AUTHZ_CONFIG" << 'AUTHZEOF'

resources:
AUTHZEOF

	# Add resource entries for each workspace
	while IFS= read -r line; do
		[[ -z "$line" ]] && continue
		line_arr=(${line//|/ })
		[[ "${#line_arr[@]}" -lt 2 ]] && continue
		workspace="${line_arr[0]}"
		github_user="${line_arr[1]}"
		$CAT >> "$AUTHZ_CONFIG" << EOF
  /code/${workspace}:
    users:
      - ${github_user}
EOF
	done < "$USERNAMES_FILE"

	$ECHO -e "	$(ColorGreen 'Authorization config updated!')"
}

# Update the portal workspaces list
update_portal_workspaces() {
	# Build the workspaces array
	local workspaces="const WORKSPACES: Workspace[] = ["
	local first=true

	while IFS= read -r line; do
		[[ -z "$line" ]] && continue
		line_arr=(${line//|/ })
		[[ "${#line_arr[@]}" -lt 2 ]] && continue
		workspace="${line_arr[0]}"

		if [ "$first" = true ]; then
			first=false
		else
			workspaces+=","
		fi

		workspaces+="
  {
    name: '${workspace^}',
    path: '/code/${workspace}/',
    description: '${workspace^} development workspace',
  }"
	done < "$USERNAMES_FILE"

	workspaces+="
]"

	# Update the portal page.tsx file
	if [ -f "$PORTAL_PAGE" ]; then
		# Use awk to replace the WORKSPACES array
		$AWK -v new_workspaces="$workspaces" '
		/^const WORKSPACES: Workspace\[\] = \[/ {
			print new_workspaces
			# Skip until we find the closing bracket
			while (getline && !/^\]$/) {}
			next
		}
		{ print }
		' "$PORTAL_PAGE" > "${PORTAL_PAGE}.tmp" && mv "${PORTAL_PAGE}.tmp" "$PORTAL_PAGE"

		$ECHO -e "	$(ColorGreen 'Portal workspaces updated!')"
	fi
}

# This Function will add a new dev seat
add_dev() {
	local workspaceInput=""
	local githubInput=""

	while [ -z "$workspaceInput" ]; do
		$ECHO -ne "	$(ColorBlue 'Enter workspace name (lowercase, e.g., danilo):') "
		read -p " " workspaceInput
		if [ $? == 1 ] || [ -z "$workspaceInput" ] ; then
			$ECHO -e "	$(ColorRed 'ee)') Operation aborted!"
			sleep 1
			return 1
		fi
		# Convert to lowercase
		workspaceInput=$(echo "$workspaceInput" | tr '[:upper:]' '[:lower:]')
		# Validate the input
		if ! is_valid_workspace "$workspaceInput"; then
			$ECHO -e "	$(ColorRed 'ee)') Invalid entry. Use only lowercase letters and numbers!"
			sleep 1
			workspaceInput=""
			continue
		fi
		# Check if the workspace already exists
		if workspace_exists "$workspaceInput"; then
			$ECHO -e "	$(ColorOrange '!!)') Workspace '$workspaceInput' already exists!"
			sleep 1
			workspaceInput=""
			continue
		fi
	done

	while [ -z "$githubInput" ]; do
		$ECHO -ne "	$(ColorBlue 'Enter GitHub username for this workspace:') "
		read -p " " githubInput
		if [ $? == 1 ] || [ -z "$githubInput" ] ; then
			$ECHO -e "	$(ColorRed 'ee)') Operation aborted!"
			sleep 1
			return 1
		fi
		# Validate the input
		if ! is_valid_github_user "$githubInput"; then
			$ECHO -e "	$(ColorRed 'ee)') Invalid GitHub username format!"
			sleep 1
			githubInput=""
			continue
		fi
	done

	# Add the new workspace to the list
	$SED -i '/^$/d' $USERNAMES_FILE
	$ECHO "$workspaceInput|$githubInput" >> $USERNAMES_FILE

	# Update authz.yaml
	update_authz_config

	$ECHO -e "	$(ColorGreen 'Workspace successfully added!')"
	$ECHO -e "	  Workspace: $(ColorBlue $workspaceInput)"
	$ECHO -e "	  GitHub User: $(ColorBlue $githubInput)"
	$ECHO -e "	  URL: $(ColorBlue /code/$workspaceInput/)"
	sleep 2
}

del_dev() {
	local workspaceInput=""

	# Show current workspaces
	$ECHO -e "	$(ColorOrange 'Current workspaces:')"
	while IFS= read -r line; do
		[[ -z "$line" ]] && continue
		line_arr=(${line//|/ })
		$ECHO "	  - ${line_arr[0]} (${line_arr[1]})"
	done < $USERNAMES_FILE
	$ECHO ""

	while [ -z "$workspaceInput" ]; do
		$ECHO -ne "	$(ColorBlue 'Enter workspace name to delete (or empty to cancel):') "
		read -p " " workspaceInput
		if [ $? == 1 ] || [ -z "$workspaceInput" ] ; then
			$ECHO -e "	$(ColorRed 'ee)') Operation aborted!"
			sleep 1
			return 1
		fi
		# Check if the workspace exists
		if ! workspace_exists "$workspaceInput"; then
			$ECHO -e "	$(ColorOrange '!!)') Workspace '$workspaceInput' not found!"
			sleep 1
			workspaceInput=""
			continue
		fi
		# Confirm deletion
		$ECHO -ne "	$(ColorOrange '!!)') Delete workspace '$workspaceInput'? (yes/no): "
		read -p " " answer
		case $answer in
			[Yy][Ee][Ss])
				$SED -i '/^$/d' $USERNAMES_FILE
				$SED -i "/^$workspaceInput|/d" $USERNAMES_FILE
				# Update authz.yaml
				update_authz_config
				$ECHO -e "	$(ColorGreen 'Workspace removed successfully!')"
				sleep 1
				return 0
				;;
			*)
				$ECHO -e "	$(ColorRed 'ee)') Deletion cancelled!"
				sleep 1
				workspaceInput=""
				;;
		esac
	done
}

list_dev() {
	# File maintenance
	$SED -i '/^$/d' $USERNAMES_FILE

	if isdev_empty; then
		$ECHO -e "	$(ColorOrange 'No workspaces configured yet.')"
	else
		$ECHO -e "	$(ColorGreen 'Configured Workspaces:')"
		$ECHO -e "	----------------------------------------"
		printf "	%-15s %-20s %s\n" "WORKSPACE" "GITHUB USER" "URL"
		$ECHO -e "	----------------------------------------"
		while IFS= read -r line; do
			[[ -z "$line" ]] && continue
			line_arr=(${line//|/ })
			[[ "${#line_arr[@]}" -lt 2 ]] && continue
			printf "	%-15s %-20s %s\n" "${line_arr[0]}" "${line_arr[1]}" "/code/${line_arr[0]}/"
		done < $USERNAMES_FILE
		$ECHO -e "	----------------------------------------"
	fi

	# Wait for an input to continue
	$ECHO -ne "	$(ColorOrange 'Press Enter to continue...')"
	read -p " " justakey
}

rewrite_conf() {
	# Check for dev existence before proceeding
	if isdev_empty ; then
		$ECHO -e "	$(ColorOrange '!!)') No workspaces configured."
		$ECHO -ne "	$(ColorBlue 'Generate config with just infrastructure services? (yes/no):') "
		read -p " " answer
		case $answer in
			[Yy][Ee][Ss])
				;;
			*)
				$ECHO -e "	$(ColorRed 'ee)') Operation cancelled!"
				sleep 1
				return 1
				;;
		esac
	fi

	# Check for default out paths, if does not exist just create it!
	if [ ! -d "${COMPOSE_OUT_PATH}" ]; then
		$MKDIR -p "${COMPOSE_OUT_PATH}"
	fi

	# Create the base docker-compose
	DOCKER_COMPOSE_OUTPUT="${COMPOSE_OUT_PATH}/docker-compose.yml"
	$CP "$DC_HEAD_TEMPLATE" "$DOCKER_COMPOSE_OUTPUT"

	$ECHO -e "	$(ColorGreen 'Generating configuration...')"

	# Add workspace services
	while IFS= read -r line; do
		[[ -z "$line" ]] && continue
		# Split by workspace and github user
		line_arr=(${line//|/ })

		# Skip the line if invalid
		[[ "${#line_arr[@]}" -lt 2 ]] && continue
		[[ "${#line_arr[0]}" -le 1 ]] && continue

		workspace="${line_arr[0]}"
		github_user="${line_arr[1]}"

		# Create Docker Compose file for this workspace
		DOCKER_COMPOSE_TMP_OUTPUT="${COMPOSE_OUT_PATH}/docker-compose_${workspace}.yml"
		$CP "$DC_DELTA_TEMPLATE" "$DOCKER_COMPOSE_TMP_OUTPUT"
		$SED -i "s/{{USERNAME}}/${workspace}/g" $DOCKER_COMPOSE_TMP_OUTPUT
		$CAT "$DOCKER_COMPOSE_TMP_OUTPUT" >> "$DOCKER_COMPOSE_OUTPUT"
		$RM -f "$DOCKER_COMPOSE_TMP_OUTPUT"

		$ECHO "	  - Workspace: $(ColorGreen $workspace) -> GitHub: $(ColorBlue $github_user)"
	done < $USERNAMES_FILE

	# Update authz config
	update_authz_config

	# Update portal workspaces
	update_portal_workspaces

	$ECHO ""
	$ECHO -e "	$(ColorGreen 'Configuration files generated:')"
	$ECHO -e "	  - Docker Compose: $(ColorBlue ${DOCKER_COMPOSE_OUTPUT})"
	$ECHO -e "	  - Auth Config: $(ColorBlue ${AUTHZ_CONFIG})"

	# Wait for proper reading
	sleep 2
}

dc_handle() {
	local action="$1"
	local answer=""

	# Change to composers.d directory for docker compose
	cd "$COMPOSE_OUT_PATH" 2>/dev/null || {
		$ECHO -e "	$(ColorRed 'ee)') Compose directory not found. Run 'Rewrite Config' first!"
		sleep 1
		return 1
	}

	case $action in
		start)
			$ECHO -ne "	Starting DevBox ... "
			$DC build > /dev/null 2>&1
			$DC up -d > /dev/null 2>&1
			echo "done."
			sleep 1
		;;
		restart)
			$ECHO -ne "	$(ColorOrange '!!)') This will temporarily stop all services, are you sure? (yes/no): "
			read -p " " answer
			case $answer in
				[Yy][Ee][Ss])
					$ECHO -ne "	Restarting DevBox ... "
					$DC build > /dev/null 2>&1
					$DC up -d --force-recreate > /dev/null 2>&1
					echo "done."
					sleep 1
					;;
				*)
					$ECHO -e "	$(ColorRed 'ee)') Action cancelled!"
					sleep 1
					;;
			esac
		;;
		stop)
			$ECHO -ne "	$(ColorOrange '!!)') This will stop all services, are you sure? (yes/no): "
			read -p " " answer
			case $answer in
				[Yy][Ee][Ss])
					$ECHO -ne "	Stopping DevBox ... "
					$DC down --remove-orphans > /dev/null 2>&1
					echo "done."
					sleep 1
					;;
				*)
					$ECHO -e "	$(ColorRed 'ee)') Action cancelled!"
					sleep 1
					;;
			esac
		;;
		*)
			$ECHO -e "	$(ColorRed 'ee)') Invalid Action!"
			sleep 1
			;;
	esac

	# Return to original directory
	cd - > /dev/null 2>&1
}

##
# Color Variables
##
red='\e[31m'
green='\e[32m'
orange='\e[33m'
blue='\e[34m'
clear='\e[0m'

##
# Color Functions
##
ColorRed() {
	$ECHO -ne $red$1$clear
}
ColorGreen() {
	$ECHO -ne $green$1$clear
}
ColorOrange() {
	$ECHO -ne $orange$1$clear
}
ColorBlue() {
	$ECHO -ne $blue$1$clear
}

menu() {
	printf "\033c"
	$ECHO -ne "
        ${green}DevBox Helper${clear}
        ${blue}GitHub OAuth Authentication${clear}

	$(ColorGreen '1)') ${orange}Add${clear} a New Workspace
	$(ColorGreen '2)') ${red}Delete${clear} a Workspace
	$(ColorGreen '3)') ${orange}List${clear} all Workspaces
	$(ColorGreen '4)') ${red}Rewrite${clear} DevBox Config
	$(ColorGreen '5)') ${orange}Start${clear} DevBox
	$(ColorGreen '6)') ${red}Restart${clear} DevBox
	$(ColorGreen '7)') ${red}Stop${clear} DevBox
	$(ColorGreen '0)') Exit

	$(ColorBlue 'Choose an option:') "
	read a
	case $a in
		1) add_dev ; menu ;;
		2) del_dev ; menu ;;
		3) list_dev ; menu ;;
		4) rewrite_conf ; menu ;;
		5) dc_handle "start" ; menu ;;
		6) dc_handle "restart" ; menu ;;
		7) dc_handle "stop" ; menu ;;
		0|[Qq]) printf "\033c" ; exit 0 ;;
		*) $ECHO -e $red "	Wrong option." $clear; sleep 1 ; menu ;;
	esac
}

# Call the menu function
menu

exit 0
